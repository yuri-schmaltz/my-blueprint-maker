name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pyinstaller
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-cursor0 libxcb-xinerama0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xfixes0 libxcb-randr0 libxcb-shape0
          
      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short
          
      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --add-data "resources:resources" --icon "resources/icon.png" --name "my-blueprint-maker" main.py
          
      - name: Prepare Assets
        run: |
          ls -R dist/
          
      - name: Create DEB and RPM
        run: |
          mkdir -p packages
          # DEB
          mkdir -p pkg-deb/usr/bin
          cp dist/my-blueprint-maker pkg-deb/usr/bin/
          mkdir -p pkg-deb/DEBIAN
          cat <<EOF > pkg-deb/DEBIAN/control
          Package: my-blueprint-maker
          Version: 1.0.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Antigravity
          Description: Sprite Extractor for Blueprints
          EOF
          dpkg-deb --build pkg-deb packages/my-blueprint-maker.deb
          
          # RPM (using alien as a shortcut on Ubuntu)
          sudo apt-get install -y alien
          sudo alien -r packages/my-blueprint-maker.deb
          mv my-blueprint-maker-*.rpm packages/
          
      - name: Create AppImage
        run: |
          # Use linuxdeploy to create AppImage
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # Prepare AppDir
          mkdir -p AppDir/usr/bin
          cp dist/my-blueprint-maker AppDir/usr/bin/
          
          # Create Desktop file
          mkdir -p AppDir/usr/share/applications
          cat <<EOF > AppDir/usr/share/applications/my-blueprint-maker.desktop
          [Desktop Entry]
          Type=Application
          Name=My Blueprint Maker
          Exec=my-blueprint-maker
          Icon=my-blueprint-maker
          Categories=Utility;
          EOF
          
          # Copy Icon
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
          cp resources/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/my-blueprint-maker.png
          
          # Run linuxdeploy
          export VERSION=1.0.0
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
          
          # Move AppImage to a predictable location
          mkdir -p packages
          mv *.AppImage packages/
          
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-assets
          path: |
            dist/my-blueprint-maker
            packages/*.deb
            packages/*.rpm
            packages/*.AppImage

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --add-data "resources;resources" --icon "resources/icon.png" --name "my-blueprint-maker" main.py
          
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-assets
          path: dist/my-blueprint-maker.exe

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Display structure of downloaded files
        run: ls -R
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-assets/my-blueprint-maker
            linux-assets/*.deb
            linux-assets/*.rpm
            linux-assets/*.AppImage
            windows-assets/my-blueprint-maker.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
